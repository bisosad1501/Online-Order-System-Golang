# üìä H·ªá th·ªëng X·ª≠ l√Ω ƒê∆°n h√†ng Tr·ª±c tuy·∫øn - Ph√¢n t√≠ch v√† Thi·∫øt k·∫ø

T√†i li·ªáu n√†y tr√¨nh b√†y qu√° tr√¨nh **ph√¢n t√≠ch** v√† **thi·∫øt k·∫ø** cho h·ªá th·ªëng x·ª≠ l√Ω ƒë∆°n h√†ng tr·ª±c tuy·∫øn d·ª±a tr√™n ki·∫øn tr√∫c h∆∞·ªõng d·ªãch v·ª• (SOA), tu√¢n th·ªß c√°c nguy√™n l√Ω nh∆∞ Standardized Service Contract, Service Loose Coupling, Service Autonomy, v√† Service Composability. H·ªá th·ªëng ƒë·∫£m b·∫£o quy tr√¨nh t·ª´ ƒë·∫∑t h√†ng ƒë·∫øn giao h√†ng ƒë∆∞·ª£c th·ª±c hi·ªán **t·ª± ƒë·ªông** (th√¥ng qua Saga v√† Kafka) v√† **hi·ªáu qu·∫£** (v·ªõi REST timeout, Kafka partitioning, Redis caching, v√† t·ªëi ∆∞u t√†i nguy√™n).

---

## 1. üéØ M√¥ t·∫£ Nghi·ªáp v·ª•

H·ªá th·ªëng x·ª≠ l√Ω ƒë∆°n h√†ng tr·ª±c tuy·∫øn cho ph√©p kh√°ch h√†ng ƒë·∫∑t mua s·∫£n ph·∫©m t·ª´ c·ª≠a h√†ng tr·ª±c tuy·∫øn. H·ªá th·ªëng t·ª± ƒë·ªông x·ª≠ l√Ω ƒë∆°n h√†ng b·∫±ng c√°ch x√°c minh t√¨nh tr·∫°ng h√†ng trong kho, x√°c nh·∫≠n ƒë∆°n h√†ng, x·ª≠ l√Ω thanh to√°n, v√† l√™n l·ªãch giao h√†ng, ƒë·∫£m b·∫£o hi·ªáu qu·∫£ v√† ch√≠nh x√°c. N·∫øu ƒë∆°n h√†ng ƒë∆∞·ª£c thanh to√°n th√†nh c√¥ng, s·∫£n ph·∫©m s·∫Ω ƒë∆∞·ª£c g·ª≠i ƒë·∫øn kh√°ch h√†ng.

### Quy tr√¨nh nghi·ªáp v·ª• (14 b∆∞·ªõc):

1. **Kh√°ch h√†ng ƒë·∫∑t h√†ng**: Kh√°ch h√†ng duy·ªát qua c√°c s·∫£n ph·∫©m tr√™n trang web, ch·ªçn s·∫£n ph·∫©m c·∫ßn mua v√† th√™m v√†o gi·ªè h√†ng.
2. **X√°c nh·∫≠n ƒë∆°n h√†ng**: Kh√°ch h√†ng x√°c nh·∫≠n ƒë∆°n h√†ng v√† nh·∫≠p th√¥ng tin giao h√†ng, bao g·ªìm ƒë·ªãa ch·ªâ giao h√†ng v√† ph∆∞∆°ng th·ª©c thanh to√°n.
3. **Ki·ªÉm tra t√¨nh tr·∫°ng h√†ng t·ªìn kho**: H·ªá th·ªëng ki·ªÉm tra t√¨nh tr·∫°ng h√†ng t·ªìn kho ƒë·ªÉ ƒë·∫£m b·∫£o s·∫£n ph·∫©m c√≤n h√†ng v√† c√≥ th·ªÉ giao.
4. **N·∫øu h√†ng kh√¥ng c√≥ s·∫µn, th√¥ng b√°o kh√°ch h√†ng**: N·∫øu s·∫£n ph·∫©m ƒë√£ h·∫øt h√†ng, h·ªá th·ªëng th√¥ng b√°o cho kh√°ch h√†ng qua giao di·ªán ·ª©ng d·ª•ng v√† ƒë·ªÅ xu·∫•t c√°c s·∫£n ph·∫©m t∆∞∆°ng t·ª± ho·∫∑c h·ªßy ƒë∆°n h√†ng.
5. **N·∫øu h√†ng c√≥ s·∫µn, ti·∫øp t·ª•c x·ª≠ l√Ω ƒë∆°n h√†ng**: N·∫øu s·∫£n ph·∫©m c√≤n h√†ng, h·ªá th·ªëng ti·∫øp t·ª•c x·ª≠ l√Ω ƒë∆°n h√†ng.
6. **X·ª≠ l√Ω thanh to√°n**: H·ªá th·ªëng chuy·ªÉn y√™u c·∫ßu thanh to√°n ƒë·∫øn nh√† cung c·∫•p d·ªãch v·ª• thanh to√°n, nh∆∞ th·∫ª t√≠n d·ª•ng ho·∫∑c v√≠ ƒëi·ªán t·ª≠.
7. **N·∫øu thanh to√°n th·∫•t b·∫°i, th√¥ng b√°o l·ªói**: N·∫øu qu√° tr√¨nh thanh to√°n g·∫∑p l·ªói, h·ªá th·ªëng th√¥ng b√°o l·ªói qua giao di·ªán ·ª©ng d·ª•ng v√† y√™u c·∫ßu kh√°ch h√†ng nh·∫≠p l·∫°i th√¥ng tin thanh to√°n ho·∫∑c ch·ªçn ph∆∞∆°ng th·ª©c kh√°c.
8. **N·∫øu thanh to√°n th√†nh c√¥ng, x√°c nh·∫≠n ƒë∆°n h√†ng**: N·∫øu thanh to√°n th√†nh c√¥ng, h·ªá th·ªëng x√°c nh·∫≠n ƒë∆°n h√†ng v√† g·ª≠i th√¥ng b√°o cho kh√°ch h√†ng qua ·ª©ng d·ª•ng.
9. **L√™n l·ªãch giao h√†ng**: H·ªá th·ªëng l√™n l·ªãch giao h√†ng d·ª±a tr√™n ƒë·ªãa ch·ªâ giao h√†ng v√† th√¥ng tin t·ª´ ƒë∆°n v·ªã v·∫≠n chuy·ªÉn.
10. **G·ª≠i th√¥ng tin ƒë∆°n h√†ng ƒë·∫øn ƒë∆°n v·ªã v·∫≠n chuy·ªÉn**: H·ªá th·ªëng g·ª≠i th√¥ng tin v·ªÅ ƒë∆°n h√†ng v√† ƒë·ªãa ch·ªâ giao h√†ng ƒë·∫øn ƒë∆°n v·ªã v·∫≠n chuy·ªÉn.
11. **Theo d√µi tr·∫°ng th√°i giao h√†ng**: H·ªá th·ªëng theo d√µi tr·∫°ng th√°i giao h√†ng v√† c·∫≠p nh·∫≠t cho kh√°ch h√†ng qua th√¥ng b√°o trong ·ª©ng d·ª•ng.
12. **X√°c nh·∫≠n ƒë∆°n h√†ng ƒë√£ giao**: Sau khi ƒë∆°n h√†ng ƒë∆∞·ª£c giao th√†nh c√¥ng, h·ªá th·ªëng c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng th√†nh "ƒê√£ giao".
13. **G·ª≠i th√¥ng b√°o giao h√†ng th√†nh c√¥ng**: H·ªá th·ªëng g·ª≠i th√¥ng b√°o ƒë·∫øn kh√°ch h√†ng qua ·ª©ng d·ª•ng r·∫±ng ƒë∆°n h√†ng ƒë√£ ƒë∆∞·ª£c giao th√†nh c√¥ng v√† y√™u c·∫ßu kh√°ch h√†ng ƒë√°nh gi√° s·∫£n ph·∫©m.
14. **L∆∞u th√¥ng tin ƒë∆°n h√†ng v√†o h·ªá th·ªëng qu·∫£n l√Ω**: H·ªá th·ªëng l∆∞u tr·ªØ th√¥ng tin ƒë∆°n h√†ng v√†o c∆° s·ªü d·ªØ li·ªáu ƒë·ªÉ theo d√µi v√† qu·∫£n l√Ω c√°c ƒë∆°n h√†ng ƒë√£ ho√†n th√†nh.

---

## 2. üß© C√°c D·ªãch v·ª• ƒë√£ X√°c ƒë·ªãnh

| Service Name | Type | Responsibility | Tech Stack |
|--------------|------|----------------|------------|
| order-service | Task Service | ƒêi·ªÅu ph·ªëi quy tr√¨nh ƒë∆°n h√†ng t·ª´ t·∫°o ƒë·∫øn ho√†n th√†nh, ph√°t Kafka event ƒë·ªÉ k√≠ch ho·∫°t th√¥ng b√°o tr·∫°ng th√°i | Go, Gin, PostgreSQL |
| user-service | Entity Service | Qu·∫£n l√Ω th√¥ng tin ng∆∞·ªùi d√πng (t√™n, email, ƒë·ªãa ch·ªâ), x√°c minh v√† c·∫≠p nh·∫≠t h·ªì s∆° | Go, Gin, PostgreSQL |
| cart-service | Entity Service | Qu·∫£n l√Ω gi·ªè h√†ng c·ªßa ng∆∞·ªùi d√πng, l∆∞u tr·ªØ s·∫£n ph·∫©m v√† s·ªë l∆∞·ª£ng, caching gi·ªè h√†ng | Go, Gin, PostgreSQL, Redis |
| inventory-service | Entity Service | Qu·∫£n l√Ω danh m·ª•c s·∫£n ph·∫©m v√† t·ªìn kho, ki·ªÉm tra v√† kh√≥a t·ªìn kho, g·ª£i √Ω s·∫£n ph·∫©m t∆∞∆°ng t·ª± d·ª±a tr√™n category/tags, caching d·ªØ li·ªáu t·ªìn kho v√† g·ª£i √Ω | Go, Gin, PostgreSQL, Redis |
| payment-service | Entity Service | X·ª≠ l√Ω giao d·ªãch thanh to√°n, t√≠ch h·ª£p v·ªõi c·ªïng thanh to√°n (Stripe) | Go, Gin, PostgreSQL |
| shipping-service | Entity Service | Qu·∫£n l√Ω giao h√†ng, l·∫≠p l·ªãch v√† theo d√µi tr·∫°ng th√°i v·ªõi nh√† v·∫≠n chuy·ªÉn (FedEx, UPS), caching tr·∫°ng th√°i giao h√†ng | Go, Gin, PostgreSQL, Redis |
| notification-service | Utility Service | L∆∞u v√† qu·∫£n l√Ω th√¥ng b√°o tr·∫°ng th√°i ƒë∆°n h√†ng trong ·ª©ng d·ª•ng (REST API, database) cho x√°c nh·∫≠n ƒë∆°n h√†ng, c·∫≠p nh·∫≠t giao h√†ng, giao h√†ng th√†nh c√¥ng | Go, Gin, PostgreSQL |
| api-gateway | Infrastructure | ƒê·ªãnh tuy·∫øn y√™u c·∫ßu t·ª´ ng∆∞·ªùi d√πng, th·ª±c thi b·∫£o m·∫≠t | Traefik |
| kafka | Infrastructure | X·ª≠ l√Ω s·ª± ki·ªán b·∫•t ƒë·ªìng b·ªô v·ªõi topic ph√¢n v√πng | Apache Kafka |
| redis | Infrastructure | Caching d·ªØ li·ªáu gi·ªè h√†ng, t·ªìn kho, g·ª£i √Ω s·∫£n ph·∫©m, v√† tr·∫°ng th√°i giao h√†ng | Redis |

### Ph√¢n b·ªï c√°c b∆∞·ªõc nghi·ªáp v·ª•:
- **cart-service**: B∆∞·ªõc 1
- **user-service**: B∆∞·ªõc 2, 8, 13
- **order-service**: B∆∞·ªõc 2, 5, 8, 12, 14
- **inventory-service**: B∆∞·ªõc 3, 4, 5
- **payment-service**: B∆∞·ªõc 6, 7, 8
- **shipping-service**: B∆∞·ªõc 9, 10, 11, 12
- **notification-service**: B∆∞·ªõc 8, 11, 13 (l∆∞u th√¥ng b√°o tr·∫°ng th√°i v√†o database)

**Ghi ch√∫**:
- Th√¥ng b√°o l·ªói (B∆∞·ªõc 4, 7) ƒë∆∞·ª£c x·ª≠ l√Ω qua REST API tr·∫£ l·ªói tr·ª±c ti·∫øp (409, 400) v√† log v√†o AuditLogs/Logrus, kh√¥ng l∆∞u trong database.
- T√≠nh nƒÉng g·ª≠i email (qua SMTP) kh√¥ng ph·∫£i c·ªët l√µi, hi·ªán ch∆∞a tri·ªÉn khai. C√≥ th·ªÉ th√™m sau b·∫±ng AWS SES ho·∫∑c SendGrid n·∫øu c·∫ßn.

---

## 3. üîÑ Giao ti·∫øp gi·ªØa c√°c D·ªãch v·ª•

H·ªá th·ªëng s·ª≠ d·ª•ng giao ti·∫øp ƒë·ªìng b·ªô (REST API) cho c√°c b∆∞·ªõc c·∫ßn ph·∫£n h·ªìi t·ª©c th√¨ v√† b·∫•t ƒë·ªìng b·ªô (Kafka) cho c√°c t√°c v·ª• n·ªÅn, v·ªõi Saga Orchestrator ƒë·ªÉ ƒë·∫£m b·∫£o tu·∫ßn t·ª± v√† hi·ªáu qu·∫£.

### 3.1. Giao ti·∫øp ƒë·ªìng b·ªô (REST API)

**Khi n√†o d√πng**:
- **B∆∞·ªõc 1**: cart-service l·∫•y gi·ªè h√†ng (ph·∫£n h·ªìi t·ª©c th√¨).
- **B∆∞·ªõc 2**: user-service x√°c minh ng∆∞·ªùi d√πng, order-service t·∫°o ƒë∆°n h√†ng (ph·∫£n h·ªìi t·ª©c th√¨).
- **B∆∞·ªõc 3, 4, 5**: inventory-service ki·ªÉm tra v√† kh√≥a t·ªìn kho, g·ª£i √Ω s·∫£n ph·∫©m, tr·∫£ l·ªói n·∫øu h·∫øt h√†ng (ph·∫£n h·ªìi t·ª©c th√¨).
- **B∆∞·ªõc 6, 7, 8**: payment-service x·ª≠ l√Ω thanh to√°n, tr·∫£ l·ªói n·∫øu th·∫•t b·∫°i (ph·∫£n h·ªìi t·ª©c th√¨).
- **B∆∞·ªõc 9, 10, 12**: shipping-service l·∫≠p l·ªãch v√† x√°c nh·∫≠n giao h√†ng (ph·∫£n h·ªìi ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i).
- **B∆∞·ªõc 8, 11, 13**: notification-service cung c·∫•p th√¥ng b√°o tr·∫°ng th√°i qua REST API cho client.

**T∆∞∆°ng t√°c**:
- **api-gateway ‚áÑ T·∫•t c·∫£ d·ªãch v·ª•**: ƒê·ªãnh tuy·∫øn y√™u c·∫ßu t·ª´ client.
- **order-service ‚áÑ user-service**: X√°c minh ng∆∞·ªùi d√πng (B∆∞·ªõc 2).
- **order-service ‚áÑ cart-service**: L·∫•y gi·ªè h√†ng (B∆∞·ªõc 1-2).
- **order-service ‚áÑ inventory-service**: Ki·ªÉm tra, kh√≥a t·ªìn kho, g·ª£i √Ω s·∫£n ph·∫©m (B∆∞·ªõc 3, 4, 5).
- **order-service ‚áÑ payment-service**: X·ª≠ l√Ω thanh to√°n (B∆∞·ªõc 6, 7, 8).
- **order-service ‚áÑ shipping-service**: L·∫≠p l·ªãch giao h√†ng (B∆∞·ªõc 9-12).
- **client ‚áÑ notification-service**: Truy v·∫•n th√¥ng b√°o (B∆∞·ªõc 8, 11, 13).

**H·ª£p ƒë·ªìng d·ªãch v·ª•**:
- C√°c d·ªãch v·ª• cung c·∫•p REST API v·ªõi h·ª£p ƒë·ªìng chu·∫©n h√≥a, bao g·ªìm c√°c endpoint ƒë·ªÉ t·∫°o ƒë∆°n h√†ng, x√°c minh ng∆∞·ªùi d√πng, qu·∫£n l√Ω gi·ªè h√†ng, ki·ªÉm tra t·ªìn kho, x·ª≠ l√Ω thanh to√°n, l·∫≠p l·ªãch giao h√†ng, v√† truy v·∫•n th√¥ng b√°o tr·∫°ng th√°i.
- M√£ l·ªói: 400 (Invalid request), 401 (Unauthorized), 409 (Conflict, e.g., inventory not available), 404 (Not found).
- Timeout: 5 gi√¢y cho t·∫•t c·∫£ API, tr·ª´ `/shipments` (retry 3 l·∫ßn, backoff 1 gi√¢y).

### 3.2. Giao ti·∫øp b·∫•t ƒë·ªìng b·ªô (Kafka)

**Khi n√†o d√πng**:
- **B∆∞·ªõc 8**: notification-service l∆∞u th√¥ng b√°o x√°c nh·∫≠n ƒë∆°n h√†ng (n·ªÅn).
- **B∆∞·ªõc 11**: notification-service l∆∞u th√¥ng b√°o c·∫≠p nh·∫≠t tr·∫°ng th√°i giao h√†ng (n·ªÅn).
- **B∆∞·ªõc 13**: notification-service l∆∞u th√¥ng b√°o giao h√†ng th√†nh c√¥ng (n·ªÅn).
- **B∆∞·ªõc 8, 12**: order-service c·∫≠p nh·∫≠t tr·∫°ng th√°i sau khi nh·∫≠n s·ª± ki·ªán t·ª´ payment-service (`payment_succeeded`) ho·∫∑c shipping-service (`shipping_completed`).

**Kafka Topics**:
- **order-events**: `order_confirmed`, `order_completed` (8 partitions, retention: 3 ng√†y)
- **payment-events**: `payment_succeeded` (8 partitions, retention: 3 ng√†y)
- **shipping-events**: `shipping_scheduled`, `shipping_status_updated`, `shipping_completed` (8 partitions, retention: 3 ng√†y)

**Service Subscriptions**:
- **payment-service**: L·∫Øng nghe `order_confirmed` ƒë·ªÉ x·ª≠ l√Ω thanh to√°n (B∆∞·ªõc 6).
- **shipping-service**: L·∫Øng nghe `payment_succeeded` ƒë·ªÉ l·∫≠p l·ªãch giao h√†ng (B∆∞·ªõc 9).
- **order-service**: L·∫Øng nghe `payment_succeeded`, `shipping_completed` ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i (B∆∞·ªõc 8, 12).
- **user-service**: L·∫Øng nghe `order_confirmed`, `order_completed` ƒë·ªÉ c·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi d√πng (B∆∞·ªõc 8, 13).
- **notification-service**: L·∫Øng nghe `order_confirmed`, `shipping_status_updated`, `shipping_completed` ƒë·ªÉ l∆∞u th√¥ng b√°o (B∆∞·ªõc 8, 11, 13).

**Error Handling**:
- **Dead-Letter Queue (DLQ)**: S·ª± ki·ªán th·∫•t b·∫°i g·ª≠i ƒë·∫øn DLQ, x·ª≠ l√Ω h√†ng ng√†y, alert qua Prometheus n·∫øu >10 message trong DLQ.
- **Retry Mechanism**: Retry 2 l·∫ßn v·ªõi exponential backoff cho Kafka consumer v√† l∆∞u th√¥ng b√°o.

### 3.3. Saga Orchestrator & Compensation Flow

**order-service** ƒëi·ªÅu ph·ªëi Saga:
1. T·∫°o ƒë∆°n h√†ng (`status=CREATED`, B∆∞·ªõc 2, validate ƒë·ªãa ch·ªâ v√† ph∆∞∆°ng th·ª©c thanh to√°n).
2. G·ªçi user-service x√°c minh ng∆∞·ªùi d√πng (REST, B∆∞·ªõc 2, retry 2 l·∫ßn).
3. G·ªçi cart-service l·∫•y gi·ªè h√†ng (REST, B∆∞·ªõc 1-2, retry 2 l·∫ßn).
4. G·ªçi inventory-service ki·ªÉm tra v√† kh√≥a t·ªìn kho (REST, B∆∞·ªõc 3, retry 2 l·∫ßn), c·∫≠p nh·∫≠t `inventory_locked=true`.
5. N·∫øu t·ªìn kho kh√¥ng ƒë·ªß, g·ªçi inventory-service g·ª£i √Ω s·∫£n ph·∫©m (REST, B∆∞·ªõc 4), tr·∫£ l·ªói 409 n·∫øu kh√°ch h√†ng h·ªßy (rollback t·ªëi ƒëa 30 gi√¢y).
6. G·ªçi payment-service x·ª≠ l√Ω thanh to√°n (REST, B∆∞·ªõc 6, retry 2 l·∫ßn), c·∫≠p nh·∫≠t `payment_processed=true`.
7. N·∫øu thanh to√°n th√†nh c√¥ng, ph√°t `order_confirmed` (B∆∞·ªõc 8), c·∫≠p nh·∫≠t `status=CONFIRMED`.
8. L√™n l·ªãch giao h√†ng (B∆∞·ªõc 9), c·∫≠p nh·∫≠t `shipping_scheduled=true`.
9. N·∫øu th·∫•t b·∫°i (h·∫øt h√†ng ho·∫∑c thanh to√°n l·ªói):
   - C·∫≠p nh·∫≠t `status=FAILED` v√† l∆∞u `failure_reason`.
   - Compensation (rollback t·ªëi ƒëa 30 gi√¢y):
     - Unlock t·ªìn kho (inventory-service, B∆∞·ªõc 4, x√≥a cache `inventory:{product_id}`).
     - Refund n·∫øu ƒë√£ charge (payment-service, B∆∞·ªõc 7).
     - X√≥a gi·ªè h√†ng (cart-service, B∆∞·ªõc 4, 7).
     - Tr·∫£ l·ªói qua REST API (B∆∞·ªõc 4, 7, m√£ l·ªói 409, 400).
     - Ghi log v√†o AuditLogs v√† Logrus.

**Compensation Flow**:
- **inventory-service**: Unlock `locked_quantity`, x√≥a cache `inventory:{product_id}`, c·∫≠p nh·∫≠t `inventory_locked=false`.
- **payment-service**: Refund giao d·ªãch, c·∫≠p nh·∫≠t `payment_processed=false`.
- **cart-service**: X√≥a gi·ªè h√†ng.
- **notification-service**: Kh√¥ng x·ª≠ l√Ω th√¥ng b√°o l·ªói (ch·ªâ l∆∞u th√¥ng b√°o tr·∫°ng th√°i).
- **order-service**: C·∫≠p nh·∫≠t `status=FAILED`, l∆∞u `failure_reason` ƒë·ªÉ theo d√µi l√Ω do th·∫•t b·∫°i.

---

## 4. üóÇÔ∏è Thi·∫øt k·∫ø D·ªØ li·ªáu

### order-service Database (PostgreSQL)
- **Orders**: `id` (string, UUID), `customer_id` (string), `status` (string, enum: CREATED, CONFIRMED, DELIVERED, FAILED), `total_amount` (numeric), `shipping_address` (string), `created_at` (timestamp), `updated_at` (timestamp), `inventory_locked` (boolean), `payment_processed` (boolean), `shipping_scheduled` (boolean), `failure_reason` (text) (index: `id`, `customer_id`, retention: 1 nƒÉm)
- **OrderItems**: `id` (string, UUID), `order_id` (string), `product_id` (string), `quantity` (integer), `price` (numeric) (index: `order_id`, retention: 1 nƒÉm)
- **AuditLogs**: `id` (string, UUID), `service_name` (string), `action` (string, enum: create_order, process_payment, inventory_error, shipment_updated), `user_id` (string), `timestamp` (timestamp), `details` (string) (index: `user_id`, `timestamp`, `action`, retention: 6 th√°ng, max size: 1GB, x√≥a b·∫£n ghi c≈© nh·∫•t khi v∆∞·ª£t)

### user-service Database (PostgreSQL)
- **Customers**: `id` (string, UUID), `name` (string), `email` (string), `address` (string), `created_at` (timestamp), `updated_at` (timestamp) (index: `id`, `email`, retention: 1 nƒÉm)

### cart-service Database (PostgreSQL)
- **Carts**: `id` (string, UUID), `customer_id` (string), `created_at` (timestamp), `updated_at` (timestamp) (index: `customer_id`, retention: 90 ng√†y)
- **CartItems**: `id` (string, UUID), `cart_id` (string), `product_id` (string), `quantity` (integer) (index: `cart_id`, retention: 90 ng√†y)
- **Cache**: Redis key `cart:{user_id}` (TTL: 3600 gi√¢y, memory limit: 100MB), invalidation khi gi·ªè h√†ng c·∫≠p nh·∫≠t ho·∫∑c h·∫øt h·∫°n (90 ng√†y).

### inventory-service Database (PostgreSQL)
- **Products**: `id` (string, UUID), `name` (string), `description` (string), `price` (numeric), `category` (string), `created_at` (timestamp) (index: `id`, `category`, retention: 1 nƒÉm)
- **ProductTags**: `product_id` (string), `tag` (string) (index: `product_id`, `tag`, retention: 1 nƒÉm)
- **Inventory**: `product_id` (string), `available_quantity` (integer), `locked_quantity` (integer), `updated_at` (timestamp) (index: `product_id`, retention: 1 nƒÉm)
- **ProductRelations**: `product_id` (string), `related_product_id` (string), `relation_type` (string, enum: category_match, tag_match), `score` (float, 0-1), `updated_at` (timestamp) (index: `product_id`, retention: 1 nƒÉm)
  - **G·ª£i √Ω s·∫£n ph·∫©m**: Truy v·∫•n ProductRelations theo `product_id`, ∆∞u ti√™n `relation_type=category_match` v√† `score` cao nh·∫•t.
- **Cache**: Redis key `inventory:{product_id}` (TTL: 60 gi√¢y), `recommendation:{product_id}` (TTL: 3600 gi√¢y), memory limit: 100MB, invalidation khi Kafka event `order_confirmed` ho·∫∑c ProductRelations c·∫≠p nh·∫≠t.

### payment-service Database (PostgreSQL)
- **Payments**: `id` (string, UUID), `order_id` (string), `amount` (numeric), `status` (string, enum: SUCCEEDED, FAILED), `payment_method` (string), `transaction_id` (string), `created_at` (timestamp) (index: `order_id`, retention: 1 nƒÉm)

### shipping-service Database (PostgreSQL)
- **Shipments**: `id` (string, UUID), `order_id` (string), `carrier` (string), `tracking_number` (string), `status` (string, enum: SCHEDULED, IN_TRANSIT, DELIVERED), `shipping_address` (string), `created_at` (timestamp), `updated_at` (timestamp) (index: `order_id`, retention: 1 nƒÉm)
- **ShipmentUpdates**: `id` (string, UUID), `shipment_id` (string), `status` (string), `description` (string), `created_at` (timestamp) (index: `shipment_id`, retention: 6 th√°ng)
- **Cache**: Redis key `shipment:{order_id}` (TTL: 300 gi√¢y, memory limit: 100MB), invalidation khi Kafka event `shipping_status_updated`, `shipping_completed`.

### notification-service Database (PostgreSQL)
- **Notifications**: `id` (string, UUID), `user_id` (string), `type` (string, enum: ORDER_CONFIRMED, SHIPPING_UPDATED, SHIPPING_COMPLETED), `content` (string), `status` (string, enum: UNREAD, READ), `created_at` (timestamp) (index: `user_id`, `created_at`, retention: 6 th√°ng, max 100 notifications/user, x√≥a th√¥ng b√°o c≈© nh·∫•t khi v∆∞·ª£t)

**Data Synchronization**:
- **Kafka Events**: ƒê·ªìng b·ªô qua Kafka (v√≠ d·ª•: notification-service l∆∞u th√¥ng b√°o sau `order_confirmed`).
- **Retention Policy**: X√≥a d·ªØ li·ªáu c≈© b·∫±ng cron job h√†ng th√°ng (v√≠ d·ª•: `DELETE FROM Notifications WHERE created_at < NOW() - INTERVAL '6 months'`).
- **Backup**: Snapshot h√†ng ng√†y, n√©n b·∫±ng gzip, l∆∞u trong AWS S3 (dung l∆∞·ª£ng t·ªëi ƒëa 100GB, retention: 1 nƒÉm).
- **Restore Process**: Kh√¥i ph·ª•c t·ª´ S3 b·∫±ng script `pg_restore`, ki·ªÉm tra t√≠nh to√†n v·∫πn d·ªØ li·ªáu tr∆∞·ªõc khi √°p d·ª•ng.

---

## 5. üîê C√°c v·∫•n ƒë·ªÅ B·∫£o m·∫≠t

- **X√°c th·ª±c v√† ·ª¶y quy·ªÅn**:
  - JWT cho x√°c th·ª±c ng∆∞·ªùi d√πng, ki·ªÉm tra t·∫°i api-gateway.
  - Role-based access control (RBAC): `customer` (ƒë·∫∑t ƒë∆°n), `admin` (qu·∫£n l√Ω).
- **B·∫£o m·∫≠t Giao ti·∫øp**:
  - HTTPS v·ªõi JWT cho giao ti·∫øp n·ªôi b·ªô v√† b√™n ngo√†i.
- **B·∫£o m·∫≠t D·ªØ li·ªáu**:
  - M√£ h√≥a th√¥ng tin thanh to√°n (AES-256).
- **B·∫£o m·∫≠t Kafka**:
  - M√£ h√≥a s·ª± ki·ªán v·ªõi SSL/TLS.
  - X√°c th·ª±c producer/consumer v·ªõi SASL/SCRAM.
- **B·∫£o m·∫≠t Redis**:
  - M√£ h√≥a d·ªØ li·ªáu v·ªõi SSL/TLS.
- **X√°c th·ª±c ƒê·∫ßu v√†o**:
  - NgƒÉn ch·∫∑n SQL Injection, XSS b·∫±ng input validation.
- **Rate Limiting & CORS**:
  - Rate limit: 100 reqs/gi√¢y t·∫°i api-gateway, tr·∫£ l·ªói 429 (Too Many Requests).
  - CORS whitelist: `*.example.com`.
- **Qu·∫£n l√Ω Secrets**:
  - L∆∞u API keys, credentials trong Docker Compose secrets, xoay v√≤ng h√†ng th√°ng.
- **Audit Logging**:
  - Ghi h√†nh ƒë·ªông nh·∫°y c·∫£m (create_order, process_payment, inventory_error, shipment_updated) v√†o b·∫£ng AuditLogs trong order-service.
- **Security Testing**:
  - Penetration testing h√†ng nƒÉm.
  - Vulnerability scanning h√†ng qu√Ω v·ªõi OWASP ZAP, v√° l·ªó h·ªïng trong 7 ng√†y sau khi ph√°t hi·ªán.

---

## 6. üì¶ K·∫ø ho·∫°ch Tri·ªÉn khai

- **Containerization**:
  - M·ªói d·ªãch v·ª• ch·∫°y trong Docker container, qu·∫£n l√Ω b·∫±ng Docker Compose.
- **Auto-Scaling**:
  - Scaling th·ªß c√¥ng b·∫±ng l·ªánh `docker-compose up --scale order-service=2`.
- **Y√™u c·∫ßu Ph·∫ßn c·ª©ng**:
  - Server t·ªëi thi·ªÉu: 2 CPU, 4GB RAM, 50GB SSD.
- **Cost Optimization**:
  - Resource limits: CPU 0.5, memory 512Mi.
- **C·∫•u h√¨nh M√¥i tr∆∞·ªùng**:
  - Bi·∫øn m√¥i tr∆∞·ªùng trong Docker Compose.
- **CI/CD**:
  - GitHub Actions: build, deploy, rolling update v·ªõi `docker-compose --no-cache` ƒë·ªÉ tr√°nh downtime.
- **Resilience & Observability**:
  - **Readiness/Liveness Probes**: M·ªói d·ªãch v·ª• cung c·∫•p endpoint `/health` ƒë·ªÉ ki·ªÉm tra tr·∫°ng th√°i.
  - **Retry**: Retry 2 l·∫ßn cho API calls (tr·ª´ `/v1/shipments`: 3 l·∫ßn, backoff 1 gi√¢y), Kafka consumer, v√† l∆∞u th√¥ng b√°o v√†o Notifications.
  - **Structured Logging**: JSON logs v·ªõi Logrus.
  - **Metrics**: Prometheus, gi√°m s√°t CPU, memory, request latency sau khi scale.
- **Service Discovery**:
  - DNS-based discovery (Docker Compose DNS).
- **Caching**:
  - Redis 1 node, memory limit 100MB, invalidation khi Kafka event ph√°t ho·∫∑c d·ªØ li·ªáu c·∫≠p nh·∫≠t.
- **Disaster Recovery**:
  - Backup database v√† Kafka snapshot h√†ng ng√†y, n√©n b·∫±ng gzip, l∆∞u trong AWS S3 (dung l∆∞·ª£ng t·ªëi ƒëa 100GB, retention: 1 nƒÉm).
  - Restore t·ª´ S3 b·∫±ng script `pg_restore`, ki·ªÉm tra t√≠nh to√†n v·∫πn d·ªØ li·ªáu.

---

## 7. üé® S∆° ƒë·ªì Ki·∫øn tr√∫c

```
                                 ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                 ‚îÇ    Client   ‚îÇ
                                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                        ‚îÇ
                                        ‚ñº
                                 ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                 ‚îÇ api-gateway ‚îÇ
                                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                        ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ                       ‚îÇ           ‚îÇ                       ‚îÇ      ‚îÇ
         ‚ñº                       ‚ñº           ‚ñº                       ‚ñº      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  order-service  ‚îÇ<--->‚îÇ  inventory- ‚îÇ    ‚îÇ   payment-  ‚îÇ    ‚îÇ  shipping-  ‚îÇ  ‚îÇnotification-‚îÇ
‚îÇ (Task Service)  ‚îÇ     ‚îÇ   service   ‚îÇ    ‚îÇ   service   ‚îÇ    ‚îÇ   service   ‚îÇ  ‚îÇ   service   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                     ‚îÇ                  ‚îÇ                  ‚îÇ                ‚îÇ
         ‚ñº                     ‚ñº                  ‚ñº                  ‚ñº                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Order/AuditLogs‚îÇ     ‚îÇ  Inventory  ‚îÇ    ‚îÇ   Payment   ‚îÇ    ‚îÇ   Shipping  ‚îÇ   ‚îÇ Notification‚îÇ
‚îÇ       DB        ‚îÇ     ‚îÇ     DB      ‚îÇ    ‚îÇ     DB      ‚îÇ    ‚îÇ     DB      ‚îÇ   ‚îÇ     DB      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ                                   ‚îÇ
                               ‚ñº                                   ‚ñº
                         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                         ‚îÇ    Redis    ‚îÇ                     ‚îÇ    Redis    ‚îÇ
                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ                            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ  user-      ‚îÇ
                                      ‚îÇ  service    ‚îÇ
                                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                             ‚îÇ
                                             ‚ñº
                                      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                      ‚îÇ User        ‚îÇ
                                      ‚îÇ     DB      ‚îÇ
                                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ                            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ   cart-     ‚îÇ
                                      ‚îÇ  service    ‚îÇ
                                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                             ‚îÇ
                                             ‚ñº
                                      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                      ‚îÇ Cart        ‚îÇ
                                      ‚îÇ     DB      ‚îÇ
                                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                             ‚îÇ
                                             ‚ñº
                                      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                      ‚îÇ    Redis    ‚îÇ
                                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      kafka      ‚îÇ
‚îÇ  Event Broker   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                 ‚îÇ             ‚îÇ                      ‚îÇ      ‚îÇ
                                 ‚ñº             ‚ñº                      ‚ñº      ‚ñº
                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                          ‚îÇ  inventory- ‚îÇ    ‚îÇ   payment-  ‚îÇ    ‚îÇ  shipping-  ‚îÇ  ‚îÇnotification-‚îÇ
                          ‚îÇ   service   ‚îÇ    ‚îÇ   service   ‚îÇ    ‚îÇ   service   ‚îÇ  ‚îÇ   service   ‚îÇ
                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚îÇ                  ‚îÇ                  ‚îÇ
                                 ‚ñº                  ‚ñº                  ‚ñº
                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                          ‚îÇ  Inventory  ‚îÇ    ‚îÇ   Payment   ‚îÇ    ‚îÇ   Shipping  ‚îÇ
                          ‚îÇ     DB      ‚îÇ    ‚îÇ     DB      ‚îÇ    ‚îÇ     DB      ‚îÇ
                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Kafka Data Flow**:
- `order-events` ‚Üí payment-service (B∆∞·ªõc 6), order-service (B∆∞·ªõc 8, 12), user-service (B∆∞·ªõc 8, 13), notification-service (B∆∞·ªõc 8)
- `payment-events` ‚Üí order-service (B∆∞·ªõc 8), shipping-service (B∆∞·ªõc 9)
- `shipping-events` ‚Üí order-service (B∆∞·ªõc 12), notification-service (B∆∞·ªõc 11, 13)

**Event Structures**:
- **OrderEvent**: `event_type`, `order_id`, `customer_id`, `status`, `total_amount`, `timestamp`, `items`, `failure_reason`
- **PaymentEvent**: `event_type`, `payment_id`, `order_id`, `customer_id`, `amount`, `status`, `payment_method`, `timestamp`
- **ShipmentEvent**: `event_type`, `shipment_id`, `order_id`, `status`, `timestamp`

**Compensation Flow Summary**:
- N·∫øu thanh to√°n th·∫•t b·∫°i ho·∫∑c h·∫øt h√†ng: order-service c·∫≠p nh·∫≠t `status=FAILED` v√† l∆∞u `failure_reason`, tr·∫£ l·ªói qua REST API, inventory-service unlock t·ªìn kho (B∆∞·ªõc 4, x√≥a cache), payment-service ho√†n ti·ªÅn (B∆∞·ªõc 7), cart-service x√≥a gi·ªè h√†ng, l·ªói ƒë∆∞·ª£c ghi v√†o AuditLogs v√† Logrus.

---

## 8. ‚úÖ T√≥m t·∫Øt

Ki·∫øn tr√∫c SOA n√†y ph√π h·ª£p v·ªõi UC "X·ª≠ l√Ω ƒë∆°n h√†ng tr·ª±c tuy·∫øn" v√¨:
1. **T√≠nh M√¥-ƒëun**: 7 d·ªãch v·ª• t√°ch bi·ªát tr√°ch nhi·ªám, h·ªó tr·ª£ quy tr√¨nh t·ª´ ƒë·∫∑t h√†ng ƒë·∫øn giao h√†ng.
2. **T√≠nh T·ª± ƒë·ªông**: Saga Orchestrator v√† Kafka ƒë·∫£m b·∫£o quy tr√¨nh th·ª±c hi·ªán t·ª± ƒë·ªông, tu·∫ßn t·ª± qua 14 b∆∞·ªõc.
3. **Hi·ªáu su·∫•t**: REST timeout (5 gi√¢y), Kafka partitioning (8), Redis caching (100MB), v√† resource limits t·ªëi ∆∞u h√≥a hi·ªáu su·∫•t.
4. **Kh·∫£ nƒÉng Ph·ª•c h·ªìi**: Compensation flow x·ª≠ l√Ω l·ªói (h·∫øt h√†ng, thanh to√°n th·∫•t b·∫°i).
5. **Kh·∫£ nƒÉng Theo d√µi**: Logrus v√† Prometheus h·ªó tr·ª£ gi√°m s√°t, AuditLogs ghi h√†nh ƒë·ªông nh·∫°y c·∫£m.
6. **T√≠nh Linh ho·∫°t**: D·ªÖ t√≠ch h·ª£p v·ªõi Stripe, FedEx, UPS, v√† m·ªü r·ªông v·ªõi email (ch∆∞a tri·ªÉn khai).
7. **Kh√°m ph√° D·ªãch v·ª•**: DNS-based discovery ƒë√°p ·ª©ng quy m√¥ UC.

H·ªá th·ªëng ƒë√°p ·ª©ng ƒë·∫ßy ƒë·ªß 14 b∆∞·ªõc nghi·ªáp v·ª•, tu√¢n th·ªß c√°c nguy√™n l√Ω SOA:
- **Standardized Service Contract**: H·ª£p ƒë·ªìng REST API chu·∫©n h√≥a.
- **Service Loose Coupling**: D·ªãch v·ª• ƒë·ªôc l·∫≠p, giao ti·∫øp qua api-gateway/Kafka.
- **Service Abstraction**: DNS-based discovery v√† m√£ h√≥a che gi·∫•u chi ti·∫øt tri·ªÉn khai.
- **Service Reusability**: payment-service, user-service, notification-service t√°i s·ª≠ d·ª•ng ƒë∆∞·ª£c.
- **Service Autonomy**: Database per Service (schema ri√™ng).
- **Service Statelessness**: Kafka v√† REST API.
- **Service Discoverability**: DNS-based discovery.
- **Service Composability**: Saga v√† Kafka.